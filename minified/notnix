#!/usr/bin/lua
--[[
* notnix
Copyright (c) 2025 Kamal Fasya - Licensed under the terms of the MIT license
--]]local a={}a.info="\27[32m"a.warn="\27[33m"a.error="\27[31m"local function b(c)if c==nil then return""end;return c:gsub("%s+","")end;local function d(e)local f=""if not#e then return f end;for g=1,#e do f=f..b(e[g]).." "end;return f end;local function h(e,i)local j="M.pkgs = {\n"for g=1,#e do local k='"'..e[g]..'"'..",\n"j=j..k end;j=j.."}"local l=assert(io.open(i,"w"),a.error.."[ERROR]: error opening snapshot file")l:write("-- WARNING: do not touch this file\n".."local M = {}\n"..j.."\nreturn M")l:close()end;local function m(n)local o={}table.sort(n)for g=1,#n do if n[g]==n[g+1]then table.insert(o,n[g])end end;return o end;local function p(q)local r,s=os.rename(q,q)if s then return false end;return true end;local function t()local u=os.getenv("HOME")local v=os.getenv("XDG_CONFIG_HOME")local w=v and v.."notnix/"or u.."/.config/notnix/"if not p(w)then print(a.warn.."[WARNING]: notnix config folder not found")print(a.info.."[INFO]: creating folder "..w)os.execute("mkdir "..w)end;if not p(w..".snapshot.lua")then local l=assert(io.open(w..".snapshot.lua","w"),a.error.."[ERROR]: cant create snapshot file")l:write([[-- WARNING: do not touch this file
local M = {}
M.pkgs = {}
return M
        ]])l:close()end;if not p(w.."config.lua")then print(a.warn.."[WARNING]: config file doesn't exist")print(a.info.."[INFO]: creating config file, see "..w.." for config options")local l=assert(io.open(w.."config.lua","w"),a.error.."[ERROR]: cant create config file")l:write([[local Config = {}

-- list of all pkgs that want to be installed
-- to remove package simply remove it from this list.
-- [field-type]    : string
Config.pkgs = {
    "neovim",
}

-- change according to pkg manager & must include sudo
-- e.g "sudo apt install" for debian-based distro
-- [type]    : string
-- [default] : "sudo dnf <command>"
Config.install = "sudo dnf install"
Config.remove = "sudo dnf remove"
Config.upgrade = "sudo dnf upgrade"

-- no more Y/n confirmation before install/remove
-- [type]    : boolean
-- [default] : false
Config.assume_yes_install = false
Config.assume_yes_remove = false

return Config]])l:close()end;return w end;function detect_change_pkgs(k,x)local y={install={},remove={}}local z={}for r,A in ipairs(x)do z[A]=true end;for r,A in ipairs(k)do if not z[A]then table.insert(y.install,A)end;z[A]=nil end;for B in pairs(z)do table.insert(y.remove,B)end;return y end;local function C()local w=t()local D=dofile(w.."config.lua")local E=dofile(w..".snapshot.lua")local F=D.assume_yes_install and"yes | "or""local G=D.assume_yes_remove and"yes | "or""local H=[[notnix: nix-like package-manager but not really
usage: ./notnix [option]
    options:
        -h      | --help | help -> show this help message
        upgrade | update | up   -> upgrading packages found in the list
]]if arg[1]~=nil and arg[1]=="-h"or arg[1]=="--help"or arg[1]=="help"then print(H)return end;local o=m(D.pkgs)if#o>0 then print(a.error.."[ERROR]: found duplicate:")for g=1,#o do print(a.error.."\t- "..o[g])end;print(a.error.."[ERROR]: please remove duplicates to continue")return end;if arg[1]~=nil and arg[1]=="up"or arg[1]=="update"or arg[1]=="upgrade"then print(a.info.."[INFO]: Upgrading packages")os.execute(F..D.upgrade.." "..d(D.pkgs))return end;local n=detect_change_pkgs(D.pkgs,E.pkgs)if#n.install==0 and#n.remove==0 then print(a.info.."[INFO]: Nothing to do, no packages added/removed")return end;if#n.install>0 then print(a.info.."[INFO]: Installing new packages:")for g=1,#n.install do print(a.info.."\t- "..n.install[g])end;local r,r,I=os.execute(F..D.install.." "..d(n.install))if I>0 then return end end;if#n.remove>0 then print(a.info.."[INFO]: Removing packages:")for g=1,#n.remove do print(a.info.."\t- "..n.remove[g])end;local r,r,I=os.execute(G..D.remove.." "..d(n.remove))if I>0 then return end end;h(D.pkgs,w..".snapshot.lua")end;C()
